<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>BlockPoker æµ‹è¯•é¢æ¿ (Web3 ç™»å½•)</title>
  <style>
    body { font-family: monospace; background: #111; color: #eee; padding: 20px; }
    input, button { margin: 4px; padding: 4px 8px; }
    #log { white-space: pre-line; border: 1px solid #444; padding: 8px; height: 300px; overflow-y: scroll; background: #000; }
  </style>
</head>
<body>

<h2>ğŸƒ BlockPoker - Web3 æµ‹è¯•é¢æ¿</h2>

<button onclick="connectWallet()">è¿æ¥ MetaMask</button>
<button onclick="loginWithWallet()">é“¾ä¸Šç™»å½•(JWT)</button>

<div id="wallet"></div>
<div id="jwt"></div>

<h3>ğŸ“¡ WebSocket</h3>
<div id="status">æœªè¿æ¥</div>
<button onclick="connectWS()">è¿æ¥ WebSocket</button>

<h3>ğŸ§© åŒ¹é…</h3>
æ± å: <input id="pool" value="default" size="8">
æ¡Œäººæ•°: <input id="tableSize" value="2" size="2">
<button onclick="joinMatch()">åŠ å…¥åŒ¹é…</button>
<button onclick="cancelMatch()">å–æ¶ˆåŒ¹é…</button>

<h3>ğŸ® åŠ¨ä½œ</h3>
<button onclick="sendAction('bet',{amount:100})">ä¸‹æ³¨100</button>
<button onclick="sendAction('fold',{})">å¼ƒç‰Œ</button>

<h3>ğŸ“œ æ—¥å¿—</h3>
<div id="log"></div>

<script>
let selectedAddress = "";
let jwtToken = "";
let ws;

//-------- å·¥å…· ----------
const logDiv = document.getElementById('log');
function log(msg) {
  logDiv.innerText += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
  logDiv.scrollTop = logDiv.scrollHeight;
}

//-------- MetaMask è¿æ¥ ----------
async function connectWallet() {
  if (!window.ethereum) {
    log("âŒ è¯·å®‰è£… MetaMask");
    return;
  }
  const accounts = await ethereum.request({method: "eth_requestAccounts"});
  selectedAddress = accounts[0];
  document.getElementById("wallet").innerText = "é’±åŒ…åœ°å€: " + selectedAddress;
  log("ğŸ”Œ å·²è¿æ¥é’±åŒ…: " + selectedAddress);
}

//-------- ä½¿ç”¨é’±åŒ…ç­¾åå¹¶æ¢ JWT ----------
async function loginWithWallet() {
  if (!selectedAddress) return log("è¯·å…ˆè¿æ¥é’±åŒ…");

  const message = "BlockPoker Login: " + selectedAddress + " " + Date.now();

  const signature = await ethereum.request({
    method: "personal_sign",
    params: [message, selectedAddress]
  });

  log("ğŸ“ å·²ç­¾å: " + signature);

  // å‘é€åˆ°åç«¯æ¢ JWT
  const resp = await fetch("http://localhost:8080/auth/web3", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({address: selectedAddress, message, signature})
  });
  const data = await resp.json();
  jwtToken = data.token;

  document.getElementById("jwt").innerText = "JWT: " + jwtToken;
  log("ğŸ« å¾—åˆ° JWT: " + jwtToken);
}

//-------- WebSocket ----------
function connectWS() {
  if (!jwtToken) return log("è¯·å…ˆç™»å½•è·å– JWT");

  ws = new WebSocket(`ws://localhost:8080/ws?token=${jwtToken}`);

  ws.onopen = () => {
    log("âœ… WS å·²è¿æ¥");
    document.getElementById('status').innerText = "å·²è¿æ¥";
  };

  ws.onmessage = (ev) => log("ğŸ“© " + ev.data);

  ws.onclose = () => {
    log("âŒ WS æ–­å¼€");
    document.getElementById('status').innerText = "æ–­å¼€";
  };
}

//-------- åŒ¹é… ----------
async function joinMatch() {
  if (!jwtToken) return log("è¯·å…ˆç™»å½•");

  const pool = document.getElementById('pool').value;
  const tableSize = parseInt(document.getElementById('tableSize').value);

  const resp = await fetch("http://localhost:8080/match/join", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + jwtToken
    },
    body: JSON.stringify({pool, tableSize})
  });

  const data = await resp.json();
  log("åŠ å…¥åŒ¹é…è¿”å›: " + JSON.stringify(data));
}

async function cancelMatch() {
  if (!jwtToken) return log("è¯·å…ˆç™»å½•");

  const resp = await fetch("http://localhost:8080/match/cancel", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + jwtToken
    }
  });

  const data = await resp.json();
  log("å–æ¶ˆè¿”å›: " + JSON.stringify(data));
}

//-------- æ¸¸æˆåŠ¨ä½œ ----------
function sendAction(action, data) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return log("WS æœªè¿æ¥");

  const msg = {type: "action", data: {action, ...data}};
  ws.send(JSON.stringify(msg));
  log("å‘é€åŠ¨ä½œ: " + JSON.stringify(msg));
}
</script>

</body>
</html>
